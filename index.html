<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/axios/0.26.1/axios.min.js"></script>
</head>
<body>
    <button id="_login">Login</button>
    <button id="_getList">Get List</button>
    <script>
        // create instance axios config
        const instance = axios.create({
            baseUrl: 'http://localhost:3000/user', //https://localhost:3000/api
            timeout: 3000 , // milliseconds
            headers: {
                'Content-Type': 'application/json'
            }
        })

        // xu li data truoc khi xuong server
        instance.interceptors.request.use( async(config)=>{
            console.log("truoc khi xuong server ");

            // if(config.url.indexOf('/user/login')>=0||config.url.indexOf('/refreshToken')>=0) {
            //     return config
            // }

            // const {token, timeExpired} = await instance.getLocalAccessToken();

            // const now = new Date().getTime();
            // if(timeExpired<now) {
            //     try {
            //         console.log('AccessToken expired!!');
            //         const {status, elements: {token, timeExpired}} = await refreshToken(); 
            //         if(status === 'success') {
            //             // set token vs timeExpired localStorage
            //             await instance.setLocalAccessToken({token, timeExpired})
            //             return config;
            //         }
            //     } catch (error) {
            //         return Promise.reject(err)
            //     }
            // }
            return config;
        }, err=>{
            return Promise.reject(err)
        })

        // xu li data sau khi reponse tu server
        instance.interceptors.response.use((response)=>{
            console.log("Sau khi server resonse ");
            return response
        }, err=>{
            return Promise.reject(err)
        })


        // function
        const btn_login = document.getElementById('_login');
        if(btn_login) {
            btn_login.addEventListener('click', async () => {
                console.log("kkkkkkkkkkkkkkkkkkk");
                const data = await login(); 
                console.log('data :>> ', data);
                // const {status, elements: {token, timeExpired}} = await login(); 
                if(status === 'success') {
                    // set token vs timeExpired localStorage
                    await instance.setLocalAccessToken({token, timeExpired})
                }
            })
        }

        const btn_getList = document.getElementById('_getList');
        if(btn_getList) {
            btn_getList.addEventListener('click', async () => {
                const users = await getUsers();
                console.log('users :>> ', users);
            })
        }

        async function getUsers(){
            return (await instance.get('/user/users')).data;
        }

        async function login(){
            const data = {
                email:"thuanquang3@gmail.com",
                password:"123456"
            }
            return (await instance.post('/user/login',data)).data;
        }

        async function refreshToken(){
            return (await instance.get('/api/refreshToken')).data;
        }

        instance.setLocalAccessToken = async ({token,timeExpired}) => {
            window.localStorage.setItem('accessToken', JSON.stringify({token, timeExpired}))
        }
        
        instance.getLocalAccessToken = async () => {
            const accessToken = window.localStorage.getItem('accessToken');
            return JSON.parse(accessToken)
        }

        // end function

    </script>
</body>
</html>